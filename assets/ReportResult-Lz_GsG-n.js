import{E as U,J as G,r as M,e as g,ae as b,af as B,w as S,d as k,c as y,z as R,x as _,F as H,t as V,o as p,m as D,y as L,a as w,f as N}from"./index-Ip9iXL88.js";import{g as Q}from"./report-BZKJbrdg.js";import{u as E}from"./utils-CltBBt4p.js";import{_ as j,a as q,u as J}from"./MessageLoading.vue_vue_type_script_setup_true_lang-ClAyMBj7.js";function P(){const e=U(),n=new G({}),s=M(!1),o=M(null),a=M(null);async function C(m){if(!s.value){s.value=!0,o.value=null,a.value=new AbortController;try{const d={id:E(),role:"user",content:m.userMessage,createdAt:Date.now()};e.add(d);const h=E();e.add({id:h,role:"assistant",content:"",createdAt:Date.now(),pending:!0}),e.setStreaming(!0);const v=e.currentThreadId;if(!v)throw new Error("Thread ID is required");await new Promise((t,u)=>{var r,l;const i=JSON.stringify({content:m.userMessage,reportConfig:m}),x=n.stream$(v,i,{signal:(r=a.value)==null?void 0:r.signal}).subscribe({next:c=>{var T,A;if(c.type==="message"&&c.data){const $=c.data,I=$.delta||$.text||$.content;I&&e.appendContent(h,I)}c.type==="error"&&(console.error("Streaming error:",c.error),e.patch(h,{content:`오류가 발생했습니다: ${((T=c.error)==null?void 0:T.message)||"Unknown error"}`,pending:!1}),u(new Error(((A=c.error)==null?void 0:A.message)||"Stream error")))},error:c=>{console.error("Report generation error:",c),e.patch(h,{content:`오류가 발생했습니다: ${c instanceof Error?c.message:"Unknown error"}`,pending:!1}),u(c)},complete:()=>{e.patch(h,{pending:!1}),t()}});(l=a.value)==null||l.signal.addEventListener("abort",()=>{x.unsubscribe()})})}catch(d){o.value=d instanceof Error?d.message:"Unknown error",console.error("Report generation error:",d)}finally{s.value=!1,e.setStreaming(!1),a.value=null}}}function f(){var m;(m=a.value)==null||m.abort()}return{generateReport:C,cancelGeneration:f,isGenerating:s,error:o}}function F(e={}){const{assistantMessage:n,isStreaming:s}=e,o=M(""),a=M(""),C=["초안을 위한 자료를 수집 중이에요.","문서의 구조를 설계하고 있어요.","초안을 작성하고 있어요. 곧 완성됩니다!"],f=g(()=>(n==null?void 0:n())??null),m=g(()=>(s==null?void 0:s())??!1),d=g(()=>{const t=f.value;return(m.value||(t==null?void 0:t.pending))&&!o.value&&!a.value}),h=new b.Renderer;h.code=function(t){const{text:u,lang:i}=t;let x=u;if(i&&B.getLanguage(i))try{x=B.highlight(u,{language:i}).value}catch(l){console.error("Highlight error:",l)}else try{x=B.highlightAuto(u).value}catch(l){console.error("Highlight error:",l)}return`<pre><code class="hljs ${i?`language-${i}`:""}">${x}</code></pre>`},b.setOptions({breaks:!0,gfm:!0,renderer:h});const v=g(()=>{var i;const t=o.value||((i=f.value)==null?void 0:i.content)||"";if(!t)return"";const u=b(t);return typeof u=="string"?u:""});return S(()=>{var t;return(t=f.value)==null?void 0:t.content},t=>{t&&(o.value=t,a.value="")},{immediate:!0}),S(()=>{var t;return(t=f.value)==null?void 0:t.error},t=>{t&&(a.value=t)},{immediate:!0}),{reportContent:o,errorMessage:a,isLoading:d,renderedContent:v,reportLoadingMessages:C}}const O={class:"w-full"},z={key:0},W=["innerHTML"],K={key:2,class:"inline-block text-red-500 text-sm mt-2 p-4"},X={key:3,class:"mt-3"},Y=k({__name:"ReportContentView",props:{isLoading:{type:Boolean},renderedContent:{},errorMessage:{},reportContent:{},reportLoadingMessages:{},hasContent:{type:Boolean},assistantMessage:{},isStreaming:{type:Boolean}},setup(e){return(n,s)=>{var o,a;return p(),y("div",O,[e.isLoading?(p(),y("div",z,[_(j,{messages:e.reportLoadingMessages},null,8,["messages"])])):e.errorMessage?R("",!0):(p(),y(H,{key:1},[e.hasContent?(p(),y("div",{key:0,class:"text-gray-800 text-base leading-7 markdown-content",innerHTML:e.renderedContent},null,8,W)):R("",!0)],64)),e.errorMessage?(p(),y("div",K,V(e.errorMessage),1)):R("",!0),!e.isStreaming&&!e.errorMessage&&e.hasContent?(p(),y("div",X,[_(q,{content:e.reportContent||((o=e.assistantMessage)==null?void 0:o.content)||"","message-id":(a=e.assistantMessage)==null?void 0:a.id},null,8,["content","message-id"])])):R("",!0)])}}}),Z=k({__name:"ReportContent",props:{assistantMessage:{default:null},isStreaming:{type:Boolean,default:!1}},setup(e){const n=e,{reportContent:s,errorMessage:o,isLoading:a,renderedContent:C,reportLoadingMessages:f}=F({assistantMessage:()=>n.assistantMessage,isStreaming:()=>n.isStreaming}),m=g(()=>{var i;return!!(s.value&&s.value.trim().length>0||(i=n.assistantMessage)!=null&&i.content&&n.assistantMessage.content.trim().length>0)}),d=g(()=>a.value??!1),h=g(()=>C.value??""),v=g(()=>o.value??""),t=g(()=>s.value??""),u=g(()=>m.value??!1);return(i,x)=>(p(),D(Y,{"is-loading":d.value,"rendered-content":h.value,"error-message":v.value,"report-content":t.value,"report-loading-messages":L(f),"has-content":u.value,"assistant-message":e.assistantMessage,"is-streaming":e.isStreaming},null,8,["is-loading","rendered-content","error-message","report-content","report-loading-messages","has-content","assistant-message","is-streaming"]))}}),ee={key:0,class:"flex justify-center h-full px-4 py-8"},te={class:"w-full max-w-190 h-full overflow-x-auto overflow-y-auto"},se=["src"],ne={key:1,class:"flex justify-center min-h-screen py-8 px-4"},re={key:0,class:"flex flex-col items-end gap-2.5 self-stretch"},ae={class:"flex justify-end items-center gap-2.5 px-4 py-2 rounded-[20px] bg-gray-50"},oe={class:"text-base leading-relaxed text-gray-900"},ie=k({__name:"ReportResultView",props:{userMessage:{},isShipmentQuery:{type:Boolean},iframeUrl:{},assistantMessage:{},isGenerating:{type:Boolean},error:{},isStreaming:{type:Boolean}},setup(e,{expose:n}){const s=M(null);return n({containerRef:s}),(o,a)=>e.isShipmentQuery?(p(),y("div",ee,[w("div",te,[w("iframe",{src:e.iframeUrl,class:"w-full h-full border-0 rounded-lg",title:"출하실적 조회 결과",scrolling:"yes"},null,8,se)])])):(p(),y("div",ne,[w("div",{ref_key:"containerRef",ref:s,class:"w-full max-w-190 flex flex-col gap-6 py-8"},[e.userMessage?(p(),y("div",re,[w("div",ae,[w("p",oe,V(e.userMessage),1)])])):R("",!0),_(Z,{"assistant-message":e.assistantMessage,"is-streaming":e.isStreaming},null,8,["assistant-message","is-streaming"])],512)]))}}),le={class:"flex flex-col h-full overflow-hidden"},ce={class:"flex-1 overflow-auto"},ue={key:0,class:"text-center text-xs text-gray-500 py-6 px-4"},ge="AI가 생성한 답변은 정확하지 않을 수 있으니 중요한 정보는 출처와 함께 확인하세요.",pe=k({__name:"ReportResult",props:{config:{}},setup(e){const n=e,s=U(),{generateReport:o,isGenerating:a,error:C}=P(),f=M(null),m=g(()=>{var r,l;return((r=n.config)==null?void 0:r.userMessage)||((l=s.messages.find(c=>c.role==="user"))==null?void 0:l.content)||""}),d=g(()=>{var r;return((r=n.config)==null?void 0:r.reportType)==="출하실적 조회"}),h=g(()=>!d.value||!n.config?"":Q({selectedProducts:n.config.selectedProducts,selectedRegions:n.config.selectedRegions,date:n.config.date})),v=g(()=>{const r=s.messages.filter(l=>l.role==="assistant");if(r.length!==0)return r.sort((l,c)=>c.createdAt-l.createdAt)[0]}),t=g(()=>s.isStreaming),u=M(null),{scrollToBottom:i}=J(u),x=()=>{f.value&&(u.value=f.value.containerRef)};return S(()=>{var r;return(r=v.value)==null?void 0:r.content},async()=>{t.value&&u.value&&await i()},{flush:"post"}),S(()=>f.value,()=>{x()}),N(async()=>{if(n.config){if(x(),d.value){if(s.currentThreadId){const r=s.threads.find(l=>l.id===s.currentThreadId);(!(r!=null&&r.reportConfig)||r.reportConfig.reportType!=="출하실적 조회")&&s.updateThreadReportConfig(s.currentThreadId,n.config)}return}v.value&&!v.value.pending||await o(n.config)}}),(r,l)=>(p(),y("div",le,[w("div",ce,[_(ie,{ref_key:"reportResultViewRef",ref:f,"user-message":m.value,"is-shipment-query":d.value,"iframe-url":h.value,"assistant-message":v.value,"is-generating":L(a),error:L(C),"is-streaming":t.value},null,8,["user-message","is-shipment-query","iframe-url","assistant-message","is-generating","error","is-streaming"])]),d.value?R("",!0):(p(),y("div",ue,V(ge)))]))}});export{pe as default};

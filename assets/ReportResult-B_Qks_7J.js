import{D,K as G,r as M,c,a1 as B,a2 as L,w as _,d as $,a as v,x as S,u as k,F as H,t as T,g as p,m as P,v as V,b as R,o as N}from"./index-BpRoBJd6.js";import{a as Q,g as j}from"./report-ENJDrU5c.js";import{u as E}from"./utils-CltBBt4p.js";import{_ as q,a as F,u as J}from"./FeedbackButtons.vue_vue_type_script_setup_true_lang-QEA131i3.js";function O(){const e=D(),n=new G({}),s=M(!1),i=M(null),a=M(null);async function C(f){if(!s.value){s.value=!0,i.value=null,a.value=new AbortController;try{const u={id:E(),role:"user",content:f.userMessage,createdAt:Date.now()};e.add(u);const m=E();e.add({id:m,role:"assistant",content:"",createdAt:Date.now(),pending:!0}),e.setStreaming(!0);const y=Q(f),t=e.currentThreadId;if(!t)throw new Error("Thread ID is required");await new Promise((g,o)=>{var l,w;const x=JSON.stringify({content:f.userMessage,systemPrompt:y,reportConfig:f}),r=n.stream$(t,x,{signal:(l=a.value)==null?void 0:l.signal}).subscribe({next:h=>{var A,I;if(h.type==="message"&&h.data){const b=h.data,U=b.delta||b.text||b.content;U&&e.appendContent(m,U)}h.type==="error"&&(console.error("Streaming error:",h.error),e.patch(m,{content:`오류가 발생했습니다: ${((A=h.error)==null?void 0:A.message)||"Unknown error"}`,pending:!1}),o(new Error(((I=h.error)==null?void 0:I.message)||"Stream error")))},error:h=>{console.error("Report generation error:",h),e.patch(m,{content:`오류가 발생했습니다: ${h instanceof Error?h.message:"Unknown error"}`,pending:!1}),o(h)},complete:()=>{e.patch(m,{pending:!1}),g()}});(w=a.value)==null||w.signal.addEventListener("abort",()=>{r.unsubscribe()})})}catch(u){i.value=u instanceof Error?u.message:"Unknown error",console.error("Report generation error:",u)}finally{s.value=!1,e.setStreaming(!1),a.value=null}}}function d(){var f;(f=a.value)==null||f.abort()}return{generateReport:C,cancelGeneration:d,isGenerating:s,error:i}}function K(e={}){const{assistantMessage:n,isStreaming:s}=e,i=M(""),a=M(""),C=["초안을 위한 자료를 수집 중이에요.","문서의 구조를 설계하고 있어요.","초안을 작성하고 있어요. 곧 완성됩니다!"],d=c(()=>(n==null?void 0:n())??null),f=c(()=>(s==null?void 0:s())??!1),u=c(()=>{const t=d.value;return(f.value||(t==null?void 0:t.pending))&&!i.value&&!a.value}),m=new B.Renderer;m.code=function(t){const{text:g,lang:o}=t;let x=g;if(o&&L.getLanguage(o))try{x=L.highlight(g,{language:o}).value}catch(l){console.error("Highlight error:",l)}else try{x=L.highlightAuto(g).value}catch(l){console.error("Highlight error:",l)}return`<pre><code class="hljs ${o?`language-${o}`:""}">${x}</code></pre>`},B.setOptions({breaks:!0,gfm:!0,renderer:m});const y=c(()=>{var o;const t=i.value||((o=d.value)==null?void 0:o.content)||"";if(!t)return"";const g=B(t);return typeof g=="string"?g:""});return _(()=>{var t;return(t=d.value)==null?void 0:t.content},t=>{t&&(i.value=t,a.value="")},{immediate:!0}),_(()=>{var t;return(t=d.value)==null?void 0:t.error},t=>{t&&(a.value=t)},{immediate:!0}),{reportContent:i,errorMessage:a,isLoading:u,renderedContent:y,reportLoadingMessages:C}}const W={class:"w-full"},z={key:0},X=["innerHTML"],Y={key:2,class:"inline-block text-red-500 text-sm mt-2 p-4"},Z={key:3,class:"mt-3"},ee=$({__name:"ReportContentView",props:{isLoading:{type:Boolean},renderedContent:{},errorMessage:{},reportContent:{},reportLoadingMessages:{},hasContent:{type:Boolean},assistantMessage:{},isStreaming:{type:Boolean}},setup(e){return(n,s)=>{var i,a;return p(),v("div",W,[e.isLoading?(p(),v("div",z,[k(q,{messages:e.reportLoadingMessages},null,8,["messages"])])):e.errorMessage?S("",!0):(p(),v(H,{key:1},[e.hasContent?(p(),v("div",{key:0,class:"text-gray-800 text-base leading-7 markdown-content",innerHTML:e.renderedContent},null,8,X)):S("",!0)],64)),e.errorMessage?(p(),v("div",Y,T(e.errorMessage),1)):S("",!0),!e.isStreaming&&!e.errorMessage&&e.hasContent?(p(),v("div",Z,[k(F,{content:e.reportContent||((i=e.assistantMessage)==null?void 0:i.content)||"","message-id":(a=e.assistantMessage)==null?void 0:a.id},null,8,["content","message-id"])])):S("",!0)])}}}),te=$({__name:"ReportContent",props:{assistantMessage:{default:null},isStreaming:{type:Boolean,default:!1}},setup(e){const n=e,{reportContent:s,errorMessage:i,isLoading:a,renderedContent:C,reportLoadingMessages:d}=K({assistantMessage:()=>n.assistantMessage,isStreaming:()=>n.isStreaming}),f=c(()=>{var o;return!!(s.value&&s.value.trim().length>0||(o=n.assistantMessage)!=null&&o.content&&n.assistantMessage.content.trim().length>0)}),u=c(()=>a.value??!1),m=c(()=>C.value??""),y=c(()=>i.value??""),t=c(()=>s.value??""),g=c(()=>f.value??!1);return(o,x)=>(p(),P(ee,{"is-loading":u.value,"rendered-content":m.value,"error-message":y.value,"report-content":t.value,"report-loading-messages":V(d),"has-content":g.value,"assistant-message":e.assistantMessage,"is-streaming":e.isStreaming},null,8,["is-loading","rendered-content","error-message","report-content","report-loading-messages","has-content","assistant-message","is-streaming"]))}}),se={key:0,class:"flex justify-center h-full px-4 py-8"},ne={class:"w-full max-w-190 h-full overflow-x-auto overflow-y-auto"},re=["src"],ae={key:1,class:"flex justify-center min-h-screen py-8 px-4"},oe={key:0,class:"flex flex-col items-end gap-2.5 self-stretch"},ie={class:"flex justify-end items-center gap-2.5 px-4 py-2 rounded-[20px] bg-gray-50"},le={class:"text-base leading-relaxed text-gray-900"},ce=$({__name:"ReportResultView",props:{userMessage:{},isShipmentQuery:{type:Boolean},iframeUrl:{},assistantMessage:{},isGenerating:{type:Boolean},error:{},isStreaming:{type:Boolean}},setup(e,{expose:n}){const s=M(null);return n({containerRef:s}),(i,a)=>e.isShipmentQuery?(p(),v("div",se,[R("div",ne,[R("iframe",{src:e.iframeUrl,class:"w-full h-full border-0 rounded-lg",title:"출하실적 조회 결과",scrolling:"yes"},null,8,re)])])):(p(),v("div",ae,[R("div",{ref_key:"containerRef",ref:s,class:"w-full max-w-190 flex flex-col gap-6 py-8"},[e.userMessage?(p(),v("div",oe,[R("div",ie,[R("p",le,T(e.userMessage),1)])])):S("",!0),k(te,{"assistant-message":e.assistantMessage,"is-streaming":e.isStreaming},null,8,["assistant-message","is-streaming"])],512)]))}}),ue={class:"flex flex-col h-full overflow-hidden"},ge={class:"flex-1 overflow-auto"},de={key:0,class:"text-center text-xs text-gray-500 py-6 px-4"},fe="AI가 생성한 답변은 정확하지 않을 수 있으니 중요한 정보는 출처와 함께 확인하세요.",ye=$({__name:"ReportResult",props:{config:{}},setup(e){const n=e,s=D(),{generateReport:i,isGenerating:a,error:C}=O(),d=M(null),f=c(()=>{var r,l;return((r=n.config)==null?void 0:r.userMessage)||((l=s.messages.find(w=>w.role==="user"))==null?void 0:l.content)||""}),u=c(()=>{var r;return((r=n.config)==null?void 0:r.reportType)==="출하실적 조회"}),m=c(()=>!u.value||!n.config?"":j({selectedProducts:n.config.selectedProducts,selectedRegions:n.config.selectedRegions,date:n.config.date})),y=c(()=>{const r=s.messages.filter(l=>l.role==="assistant");if(r.length!==0)return r.sort((l,w)=>w.createdAt-l.createdAt)[0]}),t=c(()=>s.isStreaming),g=M(null),{scrollToBottom:o}=J(g),x=()=>{d.value&&(g.value=d.value.containerRef)};return _(()=>{var r;return(r=y.value)==null?void 0:r.content},async()=>{t.value&&g.value&&await o()},{flush:"post"}),_(()=>d.value,()=>{x()}),N(async()=>{if(n.config){if(x(),u.value){if(s.currentThreadId){const r=s.threads.find(l=>l.id===s.currentThreadId);(!(r!=null&&r.reportConfig)||r.reportConfig.reportType!=="출하실적 조회")&&s.updateThreadReportConfig(s.currentThreadId,n.config)}return}y.value&&!y.value.pending||await i(n.config)}}),(r,l)=>(p(),v("div",ue,[R("div",ge,[k(ce,{ref_key:"reportResultViewRef",ref:d,"user-message":f.value,"is-shipment-query":u.value,"iframe-url":m.value,"assistant-message":y.value,"is-generating":V(a),error:V(C),"is-streaming":t.value},null,8,["user-message","is-shipment-query","iframe-url","assistant-message","is-generating","error","is-streaming"])]),u.value?S("",!0):(p(),v("div",de,T(fe)))]))}});export{ye as default};
